@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Resource> localizer

@model BaSalesManagementApp.MVC.Models.BranchVMs.BranchUpdateVM

@{
    ViewData["Title"] = @localizer["Update"];
    var isManager = User.IsInRole("Manager");
    var selectedCompany = Model.Companies.FirstOrDefault();
}

<div class="content-wrapper">
    <div class="container-fluid px-5 py-4">
        <h4 class="py-3 mb-4">
            <span class="text-muted fw-light">@localizer["Branch"] /</span> @localizer["Update"]
        </h4>

        <form asp-action="Update" onsubmit="return validateForm()">
            <input hidden asp-for="Id" class="form-control" />
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="mb-3">
                <label asp-for="Name" class="form-label">@localizer["BranchName"].ToString().ToUpper(new System.Globalization.CultureInfo("tr-TR"))</label>
                <input asp-for="Name" id="BranchName" class="form-control"
                       data-val="true"
                       data-val-required="@localizer[Messages.BRANCH_NAME_NOT_EMPTY]"
                       data-val-minlength="@localizer[Messages.BRANCH_NAME_MINIMUM_LENGTH]"
                       data-val-maxlength="@localizer[Messages.BRANCH_NAME_MAXIMUM_LENGTH]" />
                <span asp-validation-for="Name" id="branchNameError" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Address" class="form-label">@localizer["Address"].ToString().ToUpper(new System.Globalization.CultureInfo("tr-TR"))</label>
                <input asp-for="Address" id="Address" class="form-control"
                       data-val="true"
                       data-val-required="@localizer[Messages.BRANCH_ADDRESS_NOT_EMPTY]"
                       data-val-minlength="@localizer[Messages.BRANCH_ADDRESS_MINIMUM_LENGTH]"
                       data-val-maxlength="@localizer[Messages.BRANCH_ADDRESS_MAXIMUM_LENGTH]" />
                <span asp-validation-for="Address" id="addressError" class="text-danger"></span>
            </div>

            <div class="mb-3">
                @if (!isManager)
                {
                    <label asp-for="CompanyId" class="form-label">@localizer["BranchCompany"]</label>
                }
                @if (isManager)
                {
                    <input type="hidden" asp-for="CompanyId" value="@selectedCompany?.Id" />
                }
                else
                {
                    <select asp-for="CompanyId" id="CompanyId" class="form-control selectedCompany"
                            data-val="true"
                            data-val-required="@localizer[Messages.BRANCH_COMPANY_RELATION]">
                        @foreach (var company in Model.Companies)
                        {
                            <option value="@company.Id" selected="@(company.Id == Model.CompanyId ? "selected" : null)">
                                @company.Name
                            </option>
                        }
                    </select>
                }
                <span asp-validation-for="CompanyId" id="companyError" class="text-danger"></span>
            </div>

            <div class="mt-4">
                <input type="submit" value="@localizer["Update"]" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-secondary">@localizer["BackToList"]</a>
            </div>

            @for (int i = 0; i < Model.Companies.Count(); i++)
            {
                <input type="hidden" name="Companies[@i].Id" value="@Model.Companies.ElementAt(i).Id" />
                <input type="hidden" name="Companies[@i].Name" value="@Model.Companies.ElementAt(i).Name" />
            }
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            $('.selectedCompany').select2({
                placeholder: "@Html.Raw(localizer["Select_Company"])",
                allowClear: true,
                width: '100%',
                matcher: function (params, data) {
                    if ($.trim(params.term) === '') return data;
                    if (typeof data.text === 'undefined') return null;
                    var searchTerm = params.term.toLowerCase();
                    var optionText = data.text.toLowerCase();
                    if (optionText.indexOf(searchTerm) === 0) return data;
                    return null;
                },
                sorter: function (data) {
                    return data.sort((a, b) => a.text.localeCompare(b.text));
                },
                language: {
                    noResults: () => '@Html.Raw(localizer["No matching results"])'
                }
            });

            $('#CompanyId').on('change', function () {
                var companyValue = $(this).val();
                var errorMessage = $('#companyError');
                var requiredMessage = $(this).data('val-required');
                if (!companyValue) {
                    errorMessage.text(requiredMessage).show();
                } else {
                    errorMessage.text('').hide();
                }
            });

            $('#BranchName').on('input', function () {
                var value = $(this).val();
                var error = $('#branchNameError');
                var required = $(this).data('val-required');
                var min = $(this).data('val-minlength');
                var max = $(this).data('val-maxlength');

                if (value.length === 0) error.text(required).show();
                else if (value.length < 2) error.text(min).show();
                else if (value.length > 128) error.text(max).show();
                else error.text('').hide();

                $(this).val(value.replace(/\b\w/g, c => c.toUpperCase()));
            });

            $('#Address').on('input', function () {
                var value = $(this).val();
                var error = $('#addressError');
                var required = $(this).data('val-required');
                var min = $(this).data('val-minlength');
                var max = $(this).data('val-maxlength');

                if (value.length === 0) error.text(required).show();
                else if (value.length < 2) error.text(min).show();
                else if (value.length > 128) error.text(max).show();
                else error.text('').hide();

                $(this).val(value.replace(/\b\w/g, c => c.toUpperCase()));
            });
        });

        function validateForm() {
            var nameError = $('#branchNameError').text();
            var addressError = $('#addressError').text();
            var companyError = $('#companyError').text();
            var companyValue = $('#CompanyId').val();

            if (!companyValue) {
                $('#companyError').text($('#CompanyId').data('val-required')).show();
                return false;
            }

            if (nameError || addressError || companyError) return false;
            return true;
        }
    </script>
}
