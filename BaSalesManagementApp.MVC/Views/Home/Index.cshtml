@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Resource> localizer
@{
    ViewData["Title"] = @localizer["HomePage"];

    // ViewData["ChartLabels"] = new Dictionary<string, string>
    // {
    //     { "LbOcak", localizer["Jan"] },
    //     { "LbSubat", localizer["Feb"] },
    //     { "LbMart", localizer["Mar"] },
    //     { "LbNisan", localizer["Apr"] },
    //     { "LbMay", localizer["May"] },
    //     { "LbHaziran", localizer["Jun"] },
    //     { "LbTemmuz", localizer["Jul"] },
    //     { "LbElectronic", localizer["Electronic"] },
    //     { "LbSports", localizer["Sports"] },
    //     { "LbDecor", localizer["Decor"] },
    //     { "LbFashion", localizer["Fashion"] },
    //     { "LbWeekly", localizer["Weekly"] }
    // };
}

<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
        <div class="col-lg-8 mb-4 order-0">
            <div class="card">
                <div class="d-flex align-items-end row">
                    <div class="col-sm-7">
                        <div class="card-body">
                            <h5 class="card-title text-primary">
                                <span id="greeting"></span> 🎉
                            </h5>
                            <p class="mb-4">
                                @localizer["SalesIncrease", "72"]
                            </p>

                            <a href="@Url.Action("Index", "Badge")" class="btn btn-sm btn-outline-primary">@localizer["ViewBadges"]</a>

                        </div>
                    </div>
                    <div class="col-sm-5 text-center text-sm-left">
                        <div class="card-body pb-0 px-0 px-md-4">
                            <img src="../assets/img/illustrations/man-with-laptop-light.png"
                                 height="140"
                                 alt="View Badge User"
                                 data-app-dark-img="illustrations/man-with-laptop-dark.png"
                                 data-app-light-img="illustrations/man-with-laptop-light.png" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-4 order-1">
            <div class="row">
                <div class="col-lg-6 col-md-12 col-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="card-title d-flex align-items-start justify-content-between">
                                <div class="avatar flex-shrink-0">
                                    <img src="../assets/img/icons/unicons/chart-success.png"
                                         alt="chart success"
                                         class="rounded" />
                                </div>
                                <div class="dropdown">
                                    <button class="btn p-0"
                                            type="button"
                                            id="cardOpt3"
                                            data-bs-toggle="dropdown"
                                            aria-haspopup="true"
                                            aria-expanded="false">
                                        <i class="bx bx-dots-vertical-rounded"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt3">
                                        <a class="dropdown-item" href="javascript:void(0);">@localizer["ViewMore"]</a>
                                        @if (!User.IsInRole("Employee"))
                                        {
                                            <a class="dropdown-item" href="javascript:void(0);">@localizer["Delete"]</a>
                                        }
                                    </div>
                                </div>
                            </div>
                            <span class="fw-medium d-block mb-1">@localizer["Profit"]</span>
                            <h3 class="card-title mb-2 kpi-value" id="profit-total">-- ₺</h3>
                            <small id="profit-change" class="fw-medium">
                                <i id="profit-arrow" class="bx"></i>
                                <span id="profit-change-pct">0</span>%
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 col-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="card-title d-flex align-items-start justify-content-between">
                                <div class="avatar flex-shrink-0">
                                    <img src="../assets/img/icons/unicons/wallet-info.png"
                                         alt="Credit Card"
                                         class="rounded" />
                                </div>
                                @*  Toplam Satış Dropdownu *@
                                <div class="dropdown">
                                    <button class="btn p-0"
                                            type="button"
                                            id="cardOpt6"
                                            data-bs-toggle="dropdown"
                                            aria-haspopup="true"
                                            aria-expanded="false">
                                        <i class="bx bx-dots-vertical-rounded"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt6">
                                        <a class="dropdown-item" href="javascript:void(0);">@localizer["ViewMore"]</a>
                                        @if (!User.IsInRole("Employee"))
                                        {
                                            <a class="dropdown-item" href="javascript:void(0);">@localizer["Delete"]</a>
                                        }
                                    </div>
                                </div>
                            </div>
                            <span>@localizer["Sales"]</span>

                            <h3 class="card-title text-nowrap mb-1 kpi-value" id="sales-total">-- ₺</h3>

                            <small id="sales-change" class="fw-medium">
                                <i id="sales-arrow" class="bx"></i>
                                <span id="sales-change-pct">0</span>%
                            </small>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Total Revenue -->
        <div class="col-12 col-lg-8 order-2 order-md-3 order-lg-2 mb-4">
            <div class="card">
                <div class="row row-bordered g-0">

                    <!--Filter and Grow) -->
                    <div class="col-md-8">
                        <div class="card-body">
                            <form method="get" asp-controller="Home" asp-action="Index" class="mb-3">
                                <label for="year">@localizer["Year"]</label>
                                <select id="yearMain" class="form-select d-inline-block w-auto js-year"></select>
                            </form>

                            <div class="text-start fw-medium pt-3 mb-2">@localizer["CompanyGrowth", "62"]</div>

                            <div class="d-flex px-xxl-4 px-lg-2 p-4 gap-xxl-3 gap-lg-1 gap-3 justify-content-start">
                                <div class="d-flex">
                                    <div class="me-2">
                                        <span class="badge bg-label-primary p-2"><i class="bx bx-dollar text-primary"></i></span>
                                    </div>
                                    <div class="d-flex flex-column">
                                        <small>@localizer["YearlyGrowth"]</small>
                                        <h6 class="mb-0">@localizer["GrowthRate", "32.5"]</h6>
                                    </div>
                                </div>
                                <div class="d-flex">
                                    <div class="me-2">
                                        <span class="badge bg-label-info p-2"><i class="bx bx-wallet text-info"></i></span>
                                    </div>
                                    <div class="d-flex flex-column">
                                        <small>@localizer["MonthlyGrowth"]</small>
                                        <h6 class="mb-0">@localizer["GrowthRate", "41.2"]</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="growthChart" class="px-2"></div>
                    </div>

                    <!-- Total Revenue -->
                    <div class="col-md-4">
                        <h5 class="card-header m-0 me-2 pb-3 text-center">@localizer["TotalBalance"]</h5>
                        <div id="totalRevenueChart" class="px-2"></div>
                        <h3 id="total-balance" class="card-title text-nowrap mb-1 text-center kpi-value">
                            @((ViewBag.TotalBalance as decimal? ?? 0m).ToString("N2")) ₺
                        </h3>

                    </div>

                </div>
            </div>
        </div>
        <!--/ Total Revenue -->
        <div class="col-12 col-md-8 col-lg-4 order-3 order-md-2">
            <div class="row">
                <div class="col-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="card-title d-flex align-items-start justify-content-between">
                                <div class="avatar flex-shrink-0">
                                    <img src="../assets/img/icons/unicons/paypal.png" alt="Credit Card" class="rounded" />
                                </div>
                                <div class="dropdown">
                                    <button class="btn p-0"
                                            type="button"
                                            id="cardOpt4"
                                            data-bs-toggle="dropdown"
                                            aria-haspopup="true"
                                            aria-expanded="false">
                                        <i class="bx bx-dots-vertical-rounded"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt4">
                                        <a class="dropdown-item" href="javascript:void(0);">@localizer["ViewMore"]</a>
                                        @if (!User.IsInRole("Employee"))
                                        {
                                            <a class="dropdown-item" href="javascript:void(0);">@localizer["Delete"]</a>
                                        }
                                    </div>
                                </div>
                            </div>
                            <span class="d-block mb-1">@localizer["Payments"]</span>
                            <h3 class="card-title text-nowrap mb-1 kpi-value" id="totalPayments">$0.00</h3>
                            <small class="text-danger fw-medium"><i class="bx bx-down-arrow-alt"></i> -14.82%</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="card-title d-flex align-items-start justify-content-between">
                                <div class="avatar flex-shrink-0">
                                    <img src="../assets/img/icons/unicons/cc-primary.png" alt="Credit Card" class="rounded" />
                                </div>
                                <div class="dropdown">
                                    <button class="btn p-0"
                                            type="button"
                                            id="cardOpt1"
                                            data-bs-toggle="dropdown"
                                            aria-haspopup="true"
                                            aria-expanded="false">
                                        <i class="bx bx-dots-vertical-rounded"></i>
                                    </button>

                                    <div class="dropdown-menu" aria-labelledby="cardOpt1">
                                        <a class="dropdown-item" href="javascript:void(0);">@localizer["ViewMore"]</a>
                                        @if (!User.IsInRole("Employee"))
                                        {
                                            <a class="dropdown-item" href="javascript:void(0);">@localizer["Delete"]</a>
                                        }
                                    </div>
                                </div>
                            </div>
                            <span class="fw-medium d-block mb-1">@localizer["Transactions"]</span>
                                <h3 class="card-title mb-2" id="transactionCount">0</h3>

                        </div>
                    </div>
                </div>
                <!-- </div>
                <div class="row"> -->
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between flex-sm-row flex-column gap-3">
                                <div class="d-flex flex-sm-column flex-row align-items-start justify-content-between">
                                    <div class="card-title">
                                        <h5 class="text-nowrap mb-2">@localizer["OrderStatistics"]</h5>
                                        <span class="badge bg-label-warning rounded-pill">@localizer["Year2021"]</span>
                                    </div>
                                    <div class="mt-sm-auto">
                                        <small class="text-success text-nowrap fw-medium"><i class="bx bx-chevron-up"></i> 68.2%</small>
                                        <h3 class="mb-0">$84,686k</h3>
                                    </div>
                                </div>
                                <div id="profileReportChart"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <!-- Order Statistics -->
        <div class="col-md-6 col-lg-4 col-xl-4 order-0 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex align-items-center justify-content-between pb-0">
                    <div class="card-title mb-0">
                        <h5 class="m-0 me-2">@localizer["OrderStatistics"]</h5>
                        <small class="text-muted">@localizer["TotalSales"] <span id="total-sales">-- ₺</span></small>
                    </div>

                    <div class="mb-3 d-flex justify-content-end">
                        <form method="get" asp-controller="Home" asp-action="Index" class="d-flex align-items-center gap-2">
                            <label for="year" class="mb-0">@localizer["Year"]:</label>
                            <select id="yearStats" class="form-select form-select-sm w-auto js-year"></select>
                        </form>
                    </div>
                    <div class="dropdown">
                        <button class="btn p-0"
                                type="button"
                                id="orederStatistics"
                                data-bs-toggle="dropdown"
                                aria-haspopup="true"
                                aria-expanded="false">
                            <i class="bx bx-dots-vertical-rounded"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="orederStatistics">
                            <a class="dropdown-item" href="javascript:void(0);">@localizer["SelectAll"]</a>
                            <a class="dropdown-item" href="javascript:void(0);">@localizer["Refresh"]</a>
                            <a class="dropdown-item" href="javascript:void(0);">@localizer["Share"]</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex flex-column align-items-center gap-1">
                            <span>@localizer["TotalOrders"]</span>
                            <h2 class="mb-2">@ViewBag.TotalOrders</h2>
                        </div>
                        <div id="orderStatisticsChart"></div>
                    </div>
                    <ul class="p-0 m-0">
                        <li class="d-flex mb-4 pb-1">
                            <div class="avatar flex-shrink-0 me-3">
                                <span class="avatar-initial rounded bg-label-primary">
                                    <i class="bx bx-mobile-alt"></i>
                                </span>
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <h6 class="mb-0">@localizer["Electronic"]</h6>
                                    <small class="text-muted">@localizer["Mobile"], @localizer["Earbuds"], @localizer["TV"]</small>
                                </div>
                                <div class="user-progress">
                                    <small class="fw-medium">82.5k</small>
                                </div>
                            </div>
                        </li>
                        <li class="d-flex mb-4 pb-1">
                            <div class="avatar flex-shrink-0 me-3">
                                <span class="avatar-initial rounded bg-label-success"><i class="bx bx-closet"></i></span>
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <h6 class="mb-0">@localizer["Fashion"]</h6>
                                    <small class="text-muted">@localizer["T-shirt"], @localizer["Jeans"], @localizer["Shoes"] </small>
                                </div>
                                <div class="user-progress">
                                    <small class="fw-medium">23.8k</small>
                                </div>
                            </div>
                        </li>
                        <li class="d-flex mb-4 pb-1">
                            <div class="avatar flex-shrink-0 me-3">
                                <span class="avatar-initial rounded bg-label-info"><i class="bx bx-home-alt"></i></span>
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <h6 class="mb-0">@localizer["Decor"]</h6>
                                    <small class="text-muted">@localizer["Fine Art"], @localizer["Dining"]</small>
                                </div>
                                <div class="user-progress">
                                    <small class="fw-medium">849k</small>
                                </div>
                            </div>
                        </li>
                        <li class="d-flex">
                            <div class="avatar flex-shrink-0 me-3">
                                <span class="avatar-initial rounded bg-label-secondary">
                                    <i class="bx bx-football"></i>
                                </span>
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <h6 class="mb-0">@localizer["Sports"]</h6>
                                    <small class="text-muted">@localizer["Football"], @localizer["Cricket Kit"]</small>
                                </div>
                                <div class="user-progress">
                                    <small class="fw-medium">99</small>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!--/ Order Statistics -->
        <!-- Expense Overview -->
        <div class="col-md-6 col-lg-4 order-1 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <ul class="nav nav-pills" role="tablist">
                        <li class="nav-item">
                            <button type="button" class="nav-link active" data-type="income" onclick="loadDashboardData('income')">
                                @localizer["Income"]
                            </button>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="nav-link" data-type="expenses" onclick="loadDashboardData('expenses')">
                                @localizer["Expenses"]
                            </button>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="nav-link" data-type="profit" onclick="loadDashboardData('profit')">
                                @localizer["Profit"]
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body px-0">
                    <div class="tab-content p-0">
                        <div class="tab-pane fade show active" id="navs-tabs-line-card-income" role="tabpanel">
                            <div id="dashboardContent"></div>
                            <!-- Grafik buraya -->
                            <canvas id="monthlyChart" width="400" height="200" style="margin-top: 20px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--/ Expense Overview -->
        <!-- Transactions -->
        @* <div class="col-md-6 col-lg-4 order-2 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="card-title m-0 me-2">@localizer["Transactions"]</h5>
                    <div class="dropdown">
                        <button class="btn p-0"
                                type="button"
                                id="transactionID"
                                data-bs-toggle="dropdown"
                                aria-haspopup="true"
                                aria-expanded="false">
                            <i class="bx bx-dots-vertical-rounded"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="transactionID">
                            <a class="dropdown-item" href="javascript:void(0);">@localizer["Last28Days"]</a>
                            <a class="dropdown-item" href="javascript:void(0);">@localizer["LastMonth"]</a>
                            <a class="dropdown-item" href="javascript:void(0);">@localizer["LastYear"]</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="p-0 m-0">
                        <li class="d-flex mb-4 pb-1">
                            <div class="avatar flex-shrink-0 me-3">
                                <img src="../assets/img/icons/unicons/paypal.png" alt="User" class="rounded" />
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <small class="text-muted d-block mb-1">Paypal</small>
                                    <h6 class="mb-0">@localizer["SendMoney"]</h6>
                                </div>
                                <div class="user-progress d-flex align-items-center gap-1">
                                    <h6 class="mb-0">+82.6</h6>
                                    <span class="text-muted">USD</span>
                                </div>
                            </div>
                        </li>
                        <li class="d-flex mb-4 pb-1">
                            <div class="avatar flex-shrink-0 me-3">
                                <img src="../assets/img/icons/unicons/wallet.png" alt="User" class="rounded" />
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <small class="text-muted d-block mb-1">@localizer["Wallet"]</small>
                                    <h6 class="mb-0">Mac'D</h6>
                                </div>
                                <div class="user-progress d-flex align-items-center gap-1">
                                    <h6 class="mb-0">+270.69</h6>
                                    <span class="text-muted">USD</span>
                                </div>
                            </div>
                        </li>
                        <li class="d-flex mb-4 pb-1">
                            <div class="avatar flex-shrink-0 me-3">
                                <img src="../assets/img/icons/unicons/chart.png" alt="User" class="rounded" />
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <small class="text-muted d-block mb-1">@localizer["Transfer"]</small>
                                    <h6 class="mb-0">Refund</h6>
                                </div>
                                <div class="user-progress d-flex align-items-center gap-1">
                                    <h6 class="mb-0">+637.91</h6>
                                    <span class="text-muted">USD</span>
                                </div>
                            </div>
                        </li>
                        <li class="d-flex mb-4 pb-1">
                            <div class="avatar flex-shrink-0 me-3">
                                <img src="../assets/img/icons/unicons/cc-success.png" alt="User" class="rounded" />
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <small class="text-muted d-block mb-1">@localizer["CreditCard"]</small>
                                    <h6 class="mb-0">@localizer["OrderedFood"]</h6>
                                </div>
                                <div class="user-progress d-flex align-items-center gap-1">
                                    <h6 class="mb-0">-838.71</h6>
                                    <span class="text-muted">USD</span>
                                </div>
                            </div>
                        </li>
                        <li class="d-flex mb-4 pb-1">
                            <div class="avatar flex-shrink-0 me-3">
                                <img src="../assets/img/icons/unicons/wallet.png" alt="User" class="rounded" />
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <small class="text-muted d-block mb-1">@localizer["Wallet"]</small>
                                    <h6 class="mb-0">Starbucks</h6>
                                </div>
                                <div class="user-progress d-flex align-items-center gap-1">
                                    <h6 class="mb-0">+203.33</h6>
                                    <span class="text-muted">USD</span>
                                </div>
                            </div>
                        </li>
                        <li class="d-flex">
                            <div class="avatar flex-shrink-0 me-3">
                                <img src="../assets/img/icons/unicons/cc-warning.png" alt="User" class="rounded" />
                            </div>
                            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                <div class="me-2">
                                    <small class="text-muted d-block mb-1">@localizer["Mastercard"]</small>
                                    <h6 class="mb-0">@localizer["OrderedFood"]</h6>
                                </div>
                                <div class="user-progress d-flex align-items-center gap-1">
                                    <h6 class="mb-0">-92.45</h6>
                                    <span class="text-muted">USD</span>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div> *@
        <div class="col-md-6 col-lg-4 order-2 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="card-title m-0 me-2">Ödeme İstatistikleri</h5>
                </div>
                <div class="card-body">
                    <ul id="paymentStatsList" class="p-0 m-0 list-group list-group-flush">
                        <!-- JS ile doldurulacak -->
                    </ul>
                </div>
            </div>
        </div>


        <!--/ Transactions -->
    </div>
</div>
<style>
    /* KPI değerlerinin genel görünümü */
    .kpi-value {
        font-size: 1.25rem; /* h3'ten küçük */
        line-height: 1.25;
        margin-bottom: .25rem;
        white-space: nowrap; /* tek satır */
        overflow: hidden; /* taşanı gizle */
        text-overflow: ellipsis; /* ... */
    }

        /* Yükleniyor metnini daha küçük göster */
        .kpi-value .kpi-loading {
            font-size: .875rem; /* ~14px */
            font-weight: 500;
        }

    .kpi-loading i {
        font-size: 1rem;
    }

    /* Dar ekranlarda biraz daha küçült */
    @@media (max-width: 576px) {
        .kpi-value {
            font-size: 1.1rem;
        }
    }
</style>


<script>

    var chartLabels = @Html.Raw(Json.Serialize(ViewData["ChartLabels"]));
</script>
<script>
    // --- GLOBAL ---
    let homeInit = null;

    // Formatlayıcılar (yoksa oluştur)
    window.fmtMoney = window.fmtMoney || (v =>
      (v ?? 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ₺'
    );
    window.fmtPct = window.fmtPct || (v =>
      (v ?? 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 2 })
    );

    // Loading placeholder şablonları
    const loadingKpi   = (text) => `<span class="kpi-loading text-muted" role="status" aria-live="polite"><i class="bx bx-time-five bx-spin me-1"></i> ${text}</span>`;
    const loadingBlock = (text) => `<div class="px-3 py-2 text-muted" role="status" aria-live="polite"><i class="bx bx-sync bx-spin me-1"></i> ${text}</div>`;

    // Küçük fetch helper (JSON döner)
    async function jsonGet(url) {
      const res = await fetch(url, { cache: 'no-store', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!res.ok) {
        const t = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} ${res.statusText} — ${t}`);
      }
      return res.json();
    }

    // Init verisini getirip cache'ler
    async function ensureHomeInit(year) {
      const url = '/Home/GetHomeInit' + (year ? `?year=${encodeURIComponent(year)}` : '');
      homeInit = await jsonGet(url);
      return homeInit;
    }

    // KPI JSON'unu getir
    async function fetchSalesCardData(year) {
      const url = `/Home/GetSalesCardData?year=${encodeURIComponent(year)}`;
      return jsonGet(url);
    }

    // Sales/Profit KPI kartlarını doldur
    function renderSalesProfitCards(d) {
      // SALES (satış) kartı
      const elSales = document.getElementById('sales-total');
      if (elSales) elSales.textContent = fmtMoney(d.salesTotal);

      const elTotalSalesSmall = document.getElementById('total-sales');
      if (elTotalSalesSmall) elTotalSalesSmall.textContent = fmtMoney(d.salesTotal);

      const elPct = document.getElementById('sales-change-pct');
      if (elPct) elPct.textContent = fmtPct(d.salesChangePct);

      const elWrap  = document.getElementById('sales-change');
      const elArrow = document.getElementById('sales-arrow');
      if (elWrap && elArrow) {
        if (d.salesIsUp) {
          elArrow.className = 'bx bx-up-arrow-alt';
          elWrap.className  = 'fw-medium text-success';
        } else {
          elArrow.className = 'bx bx-down-arrow-alt';
          elWrap.className  = 'fw-medium text-danger';
        }
      }

      // Total balance (kârı buraya basıyoruz)
      const elBalance = document.getElementById('total-balance');
      if (elBalance) elBalance.textContent = fmtMoney(d.totalBalance);

      // PROFIT (kâr) kartı
      const elProfitTotal = document.getElementById('profit-total');
      if (elProfitTotal) elProfitTotal.textContent = fmtMoney(d.profitTotal);

      const elProfitPct = document.getElementById('profit-change-pct');
      if (elProfitPct) elProfitPct.textContent = fmtPct(d.profitChangePct);

      const elProfitWrap  = document.getElementById('profit-change');
      const elProfitArrow = document.getElementById('profit-arrow');
      if (elProfitWrap && elProfitArrow) {
        if (d.profitIsUp) {
          elProfitArrow.className = 'bx bx-up-arrow-alt';
          elProfitWrap.className  = 'fw-medium text-success';
        } else {
          elProfitArrow.className = 'bx bx-down-arrow-alt';
          elProfitWrap.className  = 'fw-medium text-danger';
        }
      }
    }

    // Tab'lı kartı doldur (income/expenses/profit)
    async function loadDashboardData(type) {
      // Sekme aktifliği
      document.querySelectorAll('.nav-pills .nav-link[data-type]').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-type') === type);
      });

      const host = document.getElementById('dashboardContent');
      // İlk yüklemede skeleton
      if (host && !homeInit) {
        host.innerHTML = loadingBlock('Veriler yükleniyor…');
      }

      if (!homeInit) await ensureHomeInit(); // güvenlik için

      const titleMap = {
        income: '@localizer["Income"]',
        expenses: '@localizer["Expenses"]',
        profit: '@localizer["Profit"]'
      };
      const valMap = {
        income: homeInit.income,
        expenses: homeInit.expense,
        profit: homeInit.profit
      };

      if (host) {
        host.innerHTML = `
          <div class="px-3 py-2">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">${titleMap[type] ?? ''}</h5>
              <div class="fw-bold fs-5" aria-live="polite">${fmtMoney(valMap[type] ?? 0)}</div>
            </div>
          </div>
        `;
      }

      // TODO: aylık grafik gerekiyorsa burada /Home/GetMonthlySeries ile #monthlyChart'ı güncelle
    }

    // --- Toplam Ödemeler (fetch sürümü) ---
    async function loadTotalPayments(year = null) {
      const el = document.getElementById('totalPayments');
      if (el) el.innerHTML = loadingKpi('Ödemeler yükleniyor…');

      try {
        const url = '/Home/GetTotalPayments' + (year ? `?year=${encodeURIComponent(year)}` : '');
        const response = await jsonGet(url);
        // response.totalPayments bekleniyor
        if (el) el.textContent = fmtMoney(response.totalPayments);
      } catch (e) {
        console.error('Toplam ödemeler yüklenemedi.', e);
        if (el) {
          el.innerHTML = `<span class="text-danger" role="alert">Ödemeler alınamadı</span>`;
        }
      }
    }

    // --- İlk yükleme: paralel çek, birlikte çiz ---
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const host = document.getElementById('dashboardContent');
        if (host) host.innerHTML = loadingBlock('Veriler yükleniyor…');

        // KPI kartlarına placeholder
        const s = document.getElementById('sales-total');
        if (s) s.innerHTML = loadingKpi('Ciro yükleniyor…');
        const p = document.getElementById('profit-total');
        if (p) p.innerHTML = loadingKpi('Kâr hesaplanıyor…');
        const b = document.getElementById('total-balance');
        if (b) b.innerHTML = loadingKpi('Yükleniyor…');

        const pay = document.getElementById('totalPayments');
        if (pay) pay.innerHTML = loadingKpi('Ödemeler yükleniyor…');

        const year = new Date().getFullYear();

        // İKİ İSTEĞİ + ÖDEMELERİ PARALEL AT
        const [init, kpi] = await Promise.all([
          ensureHomeInit(year),
          fetchSalesCardData(year)
        ]);

        // Yıl dropdownlarını doldur
        const fillYears = (id) => {
          const sel = document.getElementById(id);
          if (!sel) return;
          sel.innerHTML = (init.years || [])
            .map(y => `<option value="${y}" ${y === init.selectedYear ? 'selected' : ''}>${y}</option>`)
            .join('');
        };
        fillYears('yearMain');
        fillYears('yearStats');

        // Greeting
        const elGreeting = document.getElementById('greeting');
        if (elGreeting) elGreeting.textContent = init.greeting || '';

        // KPI'ları ve dashboard içeriğini aynı anda güncelle
        renderSalesProfitCards(kpi);
        await loadDashboardData('income');

        const elTransactions = document.getElementById('transactionCount');
        if (elTransactions) elTransactions.textContent = homeInit.transactionCount ?? 0;

        // Toplam ödemeleri getir
        await loadTotalPayments(init.selectedYear ?? year);

        // YIL DEĞİŞİNCE: yine paralel çek, birlikte güncelle
        document.querySelectorAll('select.js-year').forEach(sel => {
          sel.addEventListener('change', async e => {
            const y = parseInt(e.target.value, 10) || init.selectedYear;

            // skeletonları tekrar göster
            if (host) host.innerHTML = loadingBlock('Veriler yükleniyor…');
            const sEl = document.getElementById('sales-total');
            if (sEl) sEl.innerHTML = loadingKpi('Ciro yükleniyor…');
            const pEl = document.getElementById('profit-total');
            if (pEl) pEl.innerHTML = loadingKpi('Kâr hesaplanıyor…');
            const bEl = document.getElementById('total-balance');
            if (bEl) bEl.innerHTML = loadingKpi('Yükleniyor…');

            const payEl = document.getElementById('totalPayments');
            if (payEl) payEl.innerHTML = loadingKpi('Ödemeler yükleniyor…');

            const [init2, kpi2] = await Promise.all([
              ensureHomeInit(y),
              fetchSalesCardData(y)
            ]);

            const elTransactions = document.getElementById('transactionCount');
            if (elTransactions) elTransactions.textContent = init2.transactionCount ?? 0;

            renderSalesProfitCards(kpi2);

            const activeType =
              document.querySelector('.nav-pills .nav-link.active')?.getAttribute('data-type') || 'income';
            await loadDashboardData(activeType);

            // Ödemeleri de seçilen yıl ile güncelle
            await loadTotalPayments(y);
          });
        });

      } catch (err) {
        console.error(err);
        // Hata durumunda kart skeleton'una kısa mesaj bas
        const host = document.getElementById('dashboardContent');
        if (host) {
          host.innerHTML = `<div class="px-3 py-2 text-danger" role="alert">
            Bağlantı sorunu — <a href="#" onclick="location.reload()">Tekrar dene</a>
          </div>`;
        }
      }
    });

     async function loadPaymentStats(year) {
        try {
            // Ajax isteği
            const response = await fetch(`/Home/GetHomeInit?year=${year}`);
            const data = await response.json();

            const listContainer = document.getElementById('paymentStatsList');
            listContainer.innerHTML = ''; // Önce temizle

            if (!data.paymentStats || data.paymentStats.length === 0) {
                listContainer.innerHTML = '<li class="list-group-item">Ödeme bilgisi bulunamadı.</li>';
                return;
            }

            // Her ödeme tipini listele
            data.paymentStats.forEach(stat => {
                const li = document.createElement('li');
                li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');

                li.innerHTML = `
                    <span>${stat.PaymentTypeName}</span>
                    <span>
                        ${stat.UsageCount} işlem /
                        ${stat.TotalAmount.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}
                    </span>
                `;
                listContainer.appendChild(li);
            });
        } catch (err) {
            console.error('Ödeme istatistikleri yüklenirken hata:', err);
        }
    }

    // Sayfa yüklendiğinde çalıştır
    document.addEventListener('DOMContentLoaded', function() {
        const currentYear = new Date().getFullYear();
        loadPaymentStats(currentYear);
    });

</script>
